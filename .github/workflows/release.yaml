name: Release

on:
  push:
    tags:
      - v*

permissions: read-all

jobs:
  release:
    name: Release
    permissions:
      attestations: write
      contents: write
      id-token: write
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set-up Go
        uses: actions/setup-go@41dfa10bad2bb2ae585af6ee5bb4d7d973ad74ed # v5.1.0
        with:
          go-version-file: go.mod

      - name: Install Syft
        uses: action-stars/install-tool-from-github-release@ece2623611b240002e0dd73a0d685505733122f6 # v0.2.4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          owner: anchore
          repository: syft
          check_command: syft --version
          version: latest

      - name: Get changelog entry
        id: changelog_reader
        uses: mindsers/changelog-reader-action@32aa5b4c155d76c94e4ec883a223c947b2f02656 # v2.2.3
        with:
          path: ./CHANGELOG.md
          version: ${{ github.ref_name }}

      - name: Write changelog file
        id: changelog_writer
        run: |
          set -euo pipefail
          path="./changes.md"
          printf '${{ steps.changelog_reader.outputs.changes }}' > "${path}"
          echo "path=${path}" >> "${GITHUB_OUTPUT}"

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@9ed2f89a662bf1735a48bc8557fd212fa902bebf # v6.1.0
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          args: release --clean --release-notes ${{ steps.changelog_writer.outputs.path }}

      - name: Attest artifacts
        uses: actions/attest-build-provenance@ef244123eb79f2f7a7e75d99086184180e6d0018 # v1.4.4
        with:
          subject-path: dist/*
